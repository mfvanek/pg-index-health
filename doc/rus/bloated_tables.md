# Проверка раздувания таблиц

## Почему раздуваются таблицы

Частые UPDATE и DELETE операции могут вызвать заметное увеличение размера таблицы,
потому что старые версии строк [не удаляются сразу](https://postgrespro.ru/docs/postgresql/17/routine-vacuuming).
Неблокирующая очистка помечает эти устаревшие версии как удаленные и они могу потом использоваться для добавления новых строк,
но физическое место возвращается системе только, если эти удаленные строки были в конце таблице.

## Почему нужно следить за раздуванием таблиц

Хотя устаревшие записи постепенно обработаются демоном автоочистки, размер таблицы останется слишком большим, а таблица разреженной.
Это приведет к снижению производительности, потому что сканирование таблицы будет происходить медленнее.
Поэтому важно отслеживать резкое изменение размера таблиц, если данные часто обновляются.
Данные о слишком быстром росте размера таблицы могут также говорить о том, что автоочистка настроена неправильно и нужно менять эти настройки.

## SQL запрос

- [bloated_tables.sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/bloated_tables.sql)

## Тип проверки

- **runtime** (требует наличия накопленной статистики)

## Поддержка секционированных таблиц

Поддерживает секционированные таблицы. Процент раздувания считается для каждой секции отдельно.

## Как работает эта проверка

Для выполнения запроса пользователю необходимы права на чтение проверяемых таблиц.

### Принцип работы

Выполняется SQL-запрос к таблицам системной схемы pg_catalog. Они содержат статистическую информацию об основных объектах:
таблицах, индексах, столбцах.

Сначала в запросе собираются данные о таблицах. Вычисляется:
* reltuples: Ориентировочное количество строк в таблице
* heap_pages: Количество страниц, используемых для хранения данных таблицы
* toast_pages: Количество страниц, используемых для хранения больших значений
* toast_tuples: Количество строк, хранящихся в TOAST
* fill_factor: Коэффициент заполнения страницы, заданный для таблицы (по умолчанию 100)
* block_size: Размер блока в байтах (обычно 8192)
* max_align: Максимальное выравнивание данных (8 для 64-битных систем, 4 для 32-битных)
* page_header_size: Размер заголовка страницы (24 байта)
* table_tuple_header_size: Размер заголовка кортежа, включая выравнивание
* null_data_width: Общая ширина данных, исключая NULL значения
* tpl_size: Размер одного кортежа, включая выравнивание
* size_per_block: Размер блока, доступный для данных (размер блока минус размер заголовка страницы)

Также проверяется, доступна ли статистика по таблице.

Потом по этим данным определяется размер одного кортежа и общее количество страниц, используемых таблицей. Дальше оценивается количество страниц, которое должно быть использовано таблицей, и сравнивает его с фактическим количеством страниц.
И в итоге вычисляется раздутость таблицы в байтах (разница в страницах умноженная на размер блока) и в процентах. Если он превышает заданное значение (дефолтное составляет 10%), то таблица считается раздутой.

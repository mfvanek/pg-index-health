# Проверка раздувания индексов в таблицах

## Почему раздуваются индексы

Частое обновление данных может привести к раздуванию индекса по той же причине, что и
к [раздуванию таблицы](bloated_tables.md)

## Почему нужно следить за раздуванием индексов

Если индекс раздувается, то снижается производительность (приходится читать больше страниц с диска).

## SQL запрос

- [bloated_indexes.sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/bloated_indexes.sql)

## Тип проверки

- **runtime** (требует наличия накопленной статистики)

## Поддержка секционированных таблиц

Не работает для секционированных таблиц. [Тикет на исправление](https://github.com/mfvanek/pg-index-health/issues/589)

## Как работает эта проверка

Для выполнения запроса пользователю необходимы права на чтение проверяемых таблиц.

### Принцип работы

Выполняется SQL-запрос к таблицам системной схемы pg_catalog. Они содержат статистическую информацию об основных объектах:
таблицах, индексах, столбцах.

Сначала в запросе собираются данные о B-tree индексах в указанной схеме. Вычисляется:
* inner_index_name: Имя индекса
* reltuples: Ориентировочное количество строк в индексе
* relpages: Количество страниц, используемых для хранения индекса
* table_oid: OID таблицы, на которой создан индекс
* index_oid: OID индекса
*  indnatts: Количество столбцов в индексе
* nspname: Имя схемы, в которой находится индекс
* fill_factor: Коэффициент заполнения страницы, заданный для индекса (по умолчанию 90)
* indkey: Массив номеров столбцов таблицы, входящих в индекс
* block_size: Размер блока в байтах (обычно 8192)
* max_align: Максимальное выравнивание данных (8 для 64-битных систем, 4 для 32-битных)
* page_header_size: Размер заголовка страницы (24 байта)
* index_tuple_header_size: Размер заголовка кортежа, включая выравнивание
* null_data_width: Общая ширина данных, исключая NULL значения
Каждый столбец индекса рассматиривается отдельно. Индексы связываются с с соответствующими столбцами таблицы. Собранные параметры позволяют оценить количество страниц, которое должно быть использовано индексом. Оно сравнивается с фактическим количеством страниц. Учитываются те индексы, по которым доступна статистика.
После этого вычисляется разница между фактическим и оцененным количеством страниц индекса и по ней процент раздутости индекса. 
Если он превышает заданное значение (дефолтное составляет 10%), то индекс считается раздутым. Результаты сортируются по имени таблицы и имени индекса.


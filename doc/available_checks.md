## Available checks

All checks can be divided into two groups:

1. Runtime checks (those that make sense to perform only on a production database with real data and statistics).  
   Runtime checks usually [require aggregating data from all nodes in the cluster](https://github.com/mfvanek/pg-index-health/blob/3e9a63cc2a04799f3e97c9bec9b684ababca8db7/pg-index-health-core/src/main/java/io/github/mfvanek/pg/core/checks/common/Diagnostic.java#L162).
   This necessitated creating [our own abstraction over the database connection](https://github.com/mfvanek/pg-index-health/blob/3e9a63cc2a04799f3e97c9bec9b684ababca8db7/pg-index-health-jdbc-connection/src/main/java/io/github/mfvanek/pg/connection/HighAvailabilityPgConnection.java#L22).
2. Static checks (those can be run in tests on an empty database).  
   All static checks can be performed at runtime as well.

**pg-index-health** allows you to detect the following problems:

| â„–  | Description                                                                                                                        | Type               | Supports partitioning                                       | SQL query                                                                                                               |
|----|------------------------------------------------------------------------------------------------------------------------------------|--------------------|-------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------|
| 1  | Invalid (broken) indexes                                                                                                           | **runtime**/static | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/invalid_indexes.sql)                               |
| 2  | Duplicated (completely identical) indexes                                                                                          | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/duplicated_indexes.sql)                            |
| 3  | Intersected (partially identical) indexes                                                                                          | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/intersected_indexes.sql)                           |
| 4  | Unused indexes                                                                                                                     | **runtime**        | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/unused_indexes.sql)                                |
| 5  | Foreign keys without associated indexes                                                                                            | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/foreign_keys_without_index.sql)                    |
| 6  | Indexes with null values                                                                                                           | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/indexes_with_null_values.sql)                      |
| 7  | Tables with missing indexes                                                                                                        | **runtime**        | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/tables_with_missing_indexes.sql)                   |
| 8  | Tables without a primary key                                                                                                       | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/tables_without_primary_key.sql)                    |
| 9  | Indexes [bloat](https://www.percona.com/blog/2018/08/06/basic-understanding-bloat-vacuum-postgresql-mvcc/)                         | **runtime**        | [no](https://github.com/mfvanek/pg-index-health/issues/589) | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/bloated_indexes.sql)                               |
| 10 | Tables [bloat](https://www.percona.com/blog/2018/08/06/basic-understanding-bloat-vacuum-postgresql-mvcc/)                          | **runtime**        | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/bloated_tables.sql)                                |
| 11 | Tables without [description](https://www.postgresql.org/docs/current/sql-comment.html)                                             | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/tables_without_description.sql)                    |
| 12 | Columns without [description](https://www.postgresql.org/docs/current/sql-comment.html)                                            | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/columns_without_description.sql)                   |
| 13 | Columns with [json](https://www.postgresql.org/docs/current/datatype-json.html) type                                               | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/columns_with_json_type.sql)                        |
| 14 | Columns of [serial types](https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL) that are not primary keys | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/columns_with_serial_types.sql)                     |
| 15 | Functions without [description](https://www.postgresql.org/docs/current/sql-comment.html)                                          | static             | not applicable                                              | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/functions_without_description.sql)                 |
| 16 | Indexes [with boolean](https://habr.com/ru/companies/tensor/articles/488104/)                                                      | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/indexes_with_boolean.sql)                          |
| 17 | Tables with [not valid constraints](https://habr.com/ru/articles/800121/)                                                          | **runtime**/static | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/not_valid_constraints.sql)                         |
| 18 | B-tree indexes [on array columns](https://habr.com/ru/articles/800121/)                                                            | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/btree_indexes_on_array_columns.sql)                |
| 19 | [Sequence overflow](https://habr.com/ru/articles/800121/)                                                                          | **runtime**        | not applicable                                              | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/sequence_overflow.sql)                             |
| 20 | Primary keys with [serial types](https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_serial)                                | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/primary_keys_with_serial_types.sql)                |
| 21 | Duplicated ([completely identical](https://habr.com/ru/articles/803841/)) foreign keys                                             | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/duplicated_foreign_keys.sql)                       |
| 22 | Intersected ([partially identical](https://habr.com/ru/articles/803841/)) foreign keys                                             | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/intersected_foreign_keys.sql)                      |
| 23 | Possible object name overflow (identifiers with maximum length)                                                                    | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/possible_object_name_overflow.sql)                 |
| 24 | Tables are not linked to other tables                                                                                              | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/tables_not_linked_to_others.sql)                   |
| 25 | Foreign keys [with unmatched column type](https://habr.com/ru/articles/803841/)                                                    | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/foreign_keys_with_unmatched_column_type.sql)       |
| 26 | Tables with zero or one columns                                                                                                    | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/tables_with_zero_or_one_column.sql)                |
| 27 | Objects whose names do not follow the naming convention                                                                            | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/objects_not_following_naming_convention.sql)       |
| 28 | Columns whose names do not follow the naming convention                                                                            | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/columns_not_following_naming_convention.sql)       |
| 29 | Primary keys with varchar columns instead of uuids                                                                                 | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/primary_keys_with_varchar.sql)                     |
| 30 | Columns with [varchar(n)](https://www.postgresql.org/docs/current/datatype-character.html) type                                    | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/columns_with_fixed_length_varchar.sql)             |
| 31 | Indexes with unnecessary where-clause on not null column                                                                           | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/indexes_with_unnecessary_where_clause.sql)         |
| 32 | Primary keys that are most likely natural keys                                                                                     | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/primary_keys_that_most_likely_natural_keys.sql)    |
| 33 | Columns with [money](https://wiki.postgresql.org/wiki/Don%27t_Do_This#Don.27t_use_money) type                                      | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/columns_with_money_type.sql)                       |
| 34 | Indexes with a [timestamp in the middle](https://habr.com/ru/companies/tensor/articles/488104/)                                    | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/indexes_with_timestamp_in_the_middle.sql)          |
| 35 | Columns with a [timestamp](https://wiki.postgresql.org/wiki/Don't_Do_This#Don.27t_use_timestamp_.28without_time_zone.29) type      | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/columns_with_timestamp_or_timetz_type.sql)         |
| 36 | Tables where the primary key columns are not first                                                                                 | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/tables_where_primary_key_columns_not_first.sql)    |
| 37 | Tables that have all columns besides the primary key that are nullable                                                             | static             | yes                                                         | [sql](https://github.com/mfvanek/pg-index-health-sql/blob/master/sql/tables_where_all_columns_nullable_except_pk.sql)   |

### Raw SQL queries to use with other languages

See [pg-index-health-sql](https://github.com/mfvanek/pg-index-health-sql) project.

## How does it work?

### Static checks

Static checks are based on [information schema](https://www.postgresql.org/docs/current/information-schema.html)/[system catalogs](https://www.postgresql.org/docs/current/catalogs.html).
They work with a finite database state (after all migrations are applied).

### Runtime checks

**pg-index-health** utilizes [the Cumulative Statistics System](https://www.postgresql.org/docs/current/monitoring-stats.html)
(formerly known as [PostgreSQL's statistics collector](https://www.postgresql.org/docs/14/monitoring-stats.html)).

You can call `pg_stat_reset()` on each host to reset all statistics counters for the current database to zero
but the best way to do it is to use [DatabaseManagement::resetStatistics()](https://github.com/mfvanek/pg-index-health/blob/3e9a63cc2a04799f3e97c9bec9b684ababca8db7/pg-index-health/src/main/java/io/github/mfvanek/pg/health/checks/management/DatabaseManagement.java#L33) method.
